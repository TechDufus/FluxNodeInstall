---
- name: Check if NVM is installed
  ansible.builtin.command: command -v nvm
  changed_when: false
  failed_when: false
  register: nvm_installed

- name: Check if Node is installed
  ansible.builtin.command: command -v node
  args:
    executable: /bin/bash -i
  changed_when: false
  failed_when: false
  register: node_installed

- name: Get Installed Node Version
  ansible.builtin.command: node --version | cut -c2-
  args:
    executable: /bin/bash -i
  register: node_version
  changed_when: false
  failed_when: false
  when: node_installed.stdout != ""

- name: Check if Node Update is needed
  ansible.builtin.assert:
    that:
      - node_version.stdout | version(nvm.node.version, '!=')
  register: node_update_needed
  when: node_installed.stdout != ""

# To trick ansible into running the purge tasks here,
# we need to apply the 'install' tags to the purge tasks
- name: Purge NVM and Node
  ansible.builtin.include_role:
    name: nvm
    tasks_from: nvm-purge.yml
    apply:
      tags:
        - nvm-install
        - nvm
        - all
  when:
    - node_update_needed is defined
    - node_update_needed

- name: Ensure NVM Directory exists
  ansible.builtin.file:
    path: "/home/{{ global.user }}/.nvm"
    mode: "0755"
    owner: "{{ global.user }}"
    group: "{{ global.user }}"
    state: directory

- name: Adding NVM config to .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ global.user }}/.bashrc"
    marker: "# {mark} FluxNodeInstall Ansible MANAGED BLOCK"
    block: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"

- name: Download NVM Install Script
  ansible.builtin.uri:
    url: "{{ nvm.repo }}"
    return_content: true
  register: nvm_installer

- name: Run NVM Installer
  ansible.builtin.shell: |
    NVM_DIR="/home/{{ global.user }}/.nvm" bash -i
  args:
    stdin: "{{ nvm_installer.content }}"
  changed_when: false
  become: true
  become_user: "{{ global.user }}"

- name: Install Node with nvm and check version {{ nvm.node.version }}
  ansible.builtin.shell: |
    source /home/{{ global.user }}/.nvm/nvm.sh
    nvm install "{{ nvm.node.version }}"
    node --version
  args:
    executable: /bin/bash
    chdir: "/home/{{ global.user }}"
    creates: "/home/{{ global.user }}/.nvm/versions/node/v{{ nvm.node.version }}"
  become: true
  become_user: "{{ global.user }}"
