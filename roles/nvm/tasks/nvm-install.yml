---
- name: Check if NVM is installed
  ansible.builtin.shell: command -v nvm
  changed_when: false
  failed_when: false
  register: nvm_installed

- name: Check if Node is installed
  ansible.builtin.shell: command -v node
  changed_when: false
  failed_when: false
  register: node_installed

- name: Get Installed Node Version
  ansible.builtin.shell: node --version | cut -c2-
  register: node_version
  changed_when: false
  failed_when: false
  when: node_installed.stdout != ""

- name: Set Node Version
  ansible.builtin.set_fact:
    node_installed_version: "{{ node_version.stdout }}"
  when: node_installed.stdout != ""

- name: Check if Node Update is needed
  ansible.builtin.assert:
    that:
      - node_installed_version is version_compare(nvm.node.version, '!=')
    success_msg: "Node Version Needs to be Updated / Reinstalled."
    fail_msg: "Node Version is already up to date."
  register: node_update_needed
  when: node_installed.stdout != ""

# To trick ansible into running the purge tasks here,
# we need to apply the 'install' tags to the purge tasks
- name: Purge NVM and Node
  ansible.builtin.include_role:
    name: nvm
    tasks_from: nvm-purge.yml
    apply:
      tags:
        - nvm-install
        - nvm
        - all
  when:
    - node_update_needed is defined
    - node_update_needed

- name: Ensure NVM Directory exists
  ansible.builtin.file:
    path: "/home/{{ global.user }}/.nvm"
    mode: "0755"
    owner: "{{ global.user }}"
    group: "{{ global.user }}"
    state: directory

- name: Adding NVM config to .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ global.user }}/.bashrc"
    marker: "# {mark} FluxNodeInstall Ansible MANAGED BLOCK"
    block: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"

- name: Download NVM Install Script
  ansible.builtin.uri:
    url: "{{ nvm.repo }}"
    return_content: true
  register: nvm_installer

- name: Run NVM Installer
  ansible.builtin.shell: |
    NVM_DIR="/home/{{ global.user }}/.nvm" bash -i
  args:
    stdin: "{{ nvm_installer.content }}"
  changed_when: false
  become: true
  become_user: "{{ global.user }}"

- name: Install Node with nvm and check version {{ nvm.node.version }}
  ansible.builtin.shell: |
    source /home/{{ global.user }}/.nvm/nvm.sh
    nvm install "{{ nvm.node.version }}"
    node --version
  args:
    executable: /bin/bash
    chdir: "/home/{{ global.user }}"
    creates: "/home/{{ global.user }}/.nvm/versions/node/v{{ nvm.node.version }}"
  become: true
  become_user: "{{ global.user }}"

- name: Install Logrotate
  ansible.builtin.include_role:
    name: logrotate
    tasks_from: logrotate-install.yml
    apply:
      tags:
        - nvm-install
        - nvm
  when:
    - node_update_needed is defined
    - node_update_needed

- name: Install PM2
  ansible.builtin.include_role:
    name: pm2
    tasks_from: pm2-install.yml
    apply:
      tags:
        - nvm-install
        - nvm
  when:
    - node_update_needed is defined
    - node_update_needed

- name: Install Watchdog
  ansible.builtin.include_role:
    name: watchdog
    tasks_from: watchdog-install.yml
    apply:
      tags:
        - nvm-install
        - nvm
  when:
    - node_update_needed is defined
    - node_update_needed

- name: Start PM2
  ansible.builtin.include_role:
    name: pm2
    tasks_from: pm2-conf.yml
    apply:
      tags:
        - nvm-install
        - nvm
  when:
    - node_update_needed is defined
    - node_update_needed
